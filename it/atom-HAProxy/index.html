<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Все для HAProxy в Atom | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.ru">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Все для HAProxy в Atom</span></h1>

<h2 class="date">2016/04/08</h2>

</div>

<main>
<p>Появилась у меня на работе задачка - взять 3 относительно разных конфига
HAProxy, ответвившихся когда-то от общего предка, и обратно унифицировать их
в один.</p>
<p>Конфиги хорошие, большие - 800 строк каждый.</p>
<p>Приступил я к этой задаче, и сразу оступил - потому что в <a href="http://atom.io">Atom</a>,
которым я пользуюсь для редактирования всего, не было подсветки
синтаксиса конфигов HAProxy.</p>
<p>Ну у нас же тут opensource, так что тут же был нагуглен архив с
<a href="https://github.com/williamsjj/HAProxy.tmbundle">HAProxy.tmbundle</a>, который
владелец почему-то удалил. Бандлы TextMate можно конвертировать в плагины
Atom &ldquo;из коробки&rdquo;, так что именно это я и сделал, и поэтому очень быстро
получил какую-никакую подсветку конфигов.</p>
<p>Довольный, я продолжил рефакторинг этих конфигов, и тут же выяснил, что
подсветка довольно неполная. Перспектива набивать недостающие ключевые слова руками
меня совсем не прельщала, поэтому я быстро набросал примитивнейший
<a href="https://github.com/abulimov/atom-language-HAProxy/blob/master/generate.py">скрипт на питоне</a>,
который парсит официальную документацию HAProxy и выдергивает оттуда ключевые слова,
заполняя шаблон cson-файла с описанием подсветки.</p>
<p>Немного regexp-магии, и подсветка синтаксиса наконец стала меня удовлетворять,
так что я снова вернулся к рефакторингу.</p>
<p>Во время этого увлекательнейшего процесса в голову пришла мысль - насколько же
тут был бы уместен статический анализ, проще говоря - linter. Конечно,
сам HAProxy умеет проверять конфиг, и даже выводит предупреждения на некоторые
вещи, но</p>
<ul>
<li>это требует запуска самого HAProxy;</li>
<li>это не интегрировано в редактор;</li>
<li>он не показывает повторяющиеся правила;</li>
<li>он не показывает так называемый deadcode - неиспользуемые части конфига.</li>
</ul>
<p>Поскольку формат конфигов у HAProxy достаточно простой, а я уже был раззадорен
парсингом документации, пришла идея сделать простенький linter для конфигов HAProxy.</p>
<p>Выбор пал снова на <a href="http://golang.org">Go</a>, поскольку linter должен быть быстрым и надежным.</p>
<p>Конечно, первое, чему я научил свой linter - определение неиспользуемых частей конфига,
поскольку остальное можно было проверить с помощью самого HAProxy.</p>
<p>Как только это заработало, я начал делать плагин для Atom, который бы использовал
вывод моего linterа и отмечал плохие строчки.</p>
<p>Тут я конечно относительно долго тупил, поскольку на JS/CoffeeScript ничего не писал,
но в итоге за первые полдня работы был готов и прототип linter, и плагин для Atom,
так что оставшиеся полдня я рефакторил конфиги.</p>
<p>В процессе я добавлял правила, которые показывали бы те моменты, на которые я
натыкался в процессе рефакторинга, в результате чего на момент
написания этой статьи мой linter умеет сам находить следующие проблемы:</p>
<ul>
<li>использованные но не объявленные бекенды;</li>
<li>объявленные но не используемые бекенды;</li>
<li>использованные но не объявленные acl;</li>
<li>объявленные но используемые acl;</li>
<li>правила, написанные не в том порядке в котором они будут применены;</li>
<li>дублирование строк конфига;</li>
<li>наличие deprecated ключевых слов.</li>
</ul>
<p>Более того, если HAProxy все-таки установлен локально,
linter запускает его в виде <code>HAProxy -c -f filename</code>, и парсит его выхлоп.</p>
<p>В этом случае мы не запускаем те из проверок, которые реализованы в самом HAProxy,
например на наличие deprecated ключевых слов. Конечно, эта опция отключаемая.</p>
<p>При этом linter проще простого интегрировать с любым редактором -
у него есть режим вывода всех найденных проблем в JSON.</p>
<p>В общем, конфиг проверяется достаточно досконально, в Atom все изумительно
подсвечивается, так что результатом я более чем доволен и спокойно закончил
рефакторинг тех гигантских конфигов.</p>
<p>Ну а все плоды моих трудов доступны под <a href="http://opensource.org/licenses/MIT">лицензией MIT</a>
на GitHub:</p>
<ul>
<li>Подсветка синтаксиса конфигов HAProxy в Atom - <a href="https://github.com/abulimov/atom-language-HAProxy">atom-language-HAProxy</a>
(<a href="https://atom.io/packages/language-HAProxy">страничка плагина в Atom</a>)</li>
<li>Плагин для интеграции HAProxy-lint в Atom - <a href="https://github.com/abulimov/atom-linter-HAProxy">atom-linter-HAProxy</a>
(<a href="https://atom.io/packages/linter-HAProxy">страничка плагина в Atom</a>)</li>
<li>Сам HAProxy-lint - <a href="https://github.com/abulimov/HAProxy-lint">HAProxy-lint</a></li>
</ul>
<p>P.S. Заодно я научился делать релизы бинарников на GitHub с помощью
<a href="https://travis-ci.org">TravisCI</a> - это оказалось очень легко и удобно.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.ru/tags/golang/">Golang</a>

  <a href="//bulimov.ru/tags/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/">Программирование</a>

  <a href="//bulimov.ru/tags/atom/">Atom</a>

  <a href="//bulimov.ru/tags/haproxy/">HAProxy</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.ru/categories/it/">IT</a>

  <a href="//bulimov.ru/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.ru">Alexander Bulimov</a> 2013 &ndash; 2021 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

