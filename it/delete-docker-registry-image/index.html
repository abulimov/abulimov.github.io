<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>О пользе Python и костылях с Docker | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <style>
@media (prefers-color-scheme: dark) {
  body {
    background-color: white;
  }
  html, img, video, iframe {
    filter: invert(1);
  }
}
</style>

  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.me">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">О пользе Python и костылях с Docker</span></h1>

<h2 class="date">2016/03/02</h2>

</div>

<main>
<p>В процессе организации авто-очистки <a href="https://github.com/docker/distribution">Docker Registry 2</a>,
устав ждать в появления в нем столь &ldquo;ненужного&rdquo; функционала, как удаление образов
с диска (DELETE запросы удаляют тег, но сами данные остаются на диске и жрут место),
я в очередной раз прибег к помощи скрипта из
<a href="https://github.com/burnettk/delete-docker-registry-image">delete-docker-registry-image</a>,
и уперся в то, что этот самый скрипт (написанный изначально на bash) невероятно
медленно работает на большом Registry.</p>
<p>К примеру, удаления одного тега для repository с 70 тегами, в каждом из которых
много слоев, занимает <strong>49 минут</strong>. А мне надо удалить 60 старых тегов из 70.</p>
<p>Посмотрев на <a href="https://github.com/burnettk/delete-docker-registry-image/blob/aa2644234840dc31f3afd6a06691aec6aa899cbd/delete_docker_registry_image">сам скрипт</a>,
я понял, что проще и быстрее всего будет переписать его на Python, избавившись
от тысяч порождаемых в циклах процессов.</p>
<p>За час была реализована самая простая базовая функциональность, после чего
сравнение производительности показало очень солидное ускорение, так что
портирование продолжилось уже в чистовом варианте.</p>
<p>Процесс переписывания занял меньше одного рабочего дня, и был очень облегчен тем
фактом, что автор изначального скрипта снабдил свое детище
<a href="https://github.com/burnettk/delete-docker-registry-image/blob/master/test/test">тестами</a>.
Я тоже стараюсь писать тесты для важных вещей - без них рефакторинг (особенно в Python
с его динамической типизацией) превращается в ад.</p>
<h4 id="итоги">Итоги</h4>
<p>Версия на Python избавилась от зависимостей bash-скрипта типа jq, работает
на Python 2.7 и 3+, и использует только стандартную библиотеку.
Быстродействие изменилось кардинально -
то же удаление одного тега из 70 стало занимать <strong>30 секунд</strong> против
49 минут в версии на bash.</p>
<p>Конечно, я не преминул вернуть свои изменения в апстрим, так что
теперь более быстрый вариант доступен всем страждущим. Автор изначального
скрипта был крайне рад такому повороту событий.</p>
<p>После этих полезных для общественности действиям вся процедура очистки
моего registry от старых образов выполняется с помощью скрипта
<a href="https://github.com/burnettk/delete-docker-registry-image/tree/master#clean_old_versionpy">clean_old_versions.py</a>,
который лежит в том же репозитории, и который я тоже слегка доработал.</p>
<p>Для меня это отлично - проект продолжает поддерживаться апстримом, а я свою задачу
по очистке Registry выполнил, причем без создания каких-либо внутренних утилит, которые
потом еще придется поддерживать, и принес пользу сообществу - сила OpenSource в действии.</p>
<p>Единственное грустное пятно в этой истории - Docker-registry. Уже версия 2+, переписали
с Python на Go, про Docker трубят все кому не лень, а таких простых вещей как удаление образов - нет,
и приходится городить костыли.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.me/tags/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/">Программирование</a>

  <a href="//bulimov.me/tags/python/">Python</a>

  <a href="//bulimov.me/tags/docker/">Docker</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.me/categories/it/">IT</a>

  <a href="//bulimov.me/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.me">Alexander Bulimov</a> 2013 &ndash; 2025 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

