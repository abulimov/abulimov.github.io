<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Балансировка в HAProxy на основе данных cAdvisor | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.me">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Балансировка в HAProxy на основе данных cAdvisor</span></h1>

<h2 class="date">2015/04/15</h2>

</div>

<main>
<p>Для запуска Docker-контейнеров у меня в данный момент выделено достаточно много
серверов, причем аппаратная часть у некоторых из них отличается
друг от друга. Соответственно, при настройке на чудесном балансировщике
<a href="http://www.haproxy.org/">HAProxy</a> такого параметра балансировки
как <em>&ldquo;вес сервера&rdquo;</em>, приходится это различие в аппаратной части учитывать.</p>
<p>Можно, конечно, подобрать значения весов самостоятельно на основе
данных мониторинга, а при появлении нагрузки от соседних Docker-контейнеров
эти веса корректировать, но это не наш метод.</p>
<p>Не так давно я <a href="/it/check-cadvisor">писал</a> о том, как использую данные из
<a href="https://github.com/google/cadvisor">cAdvisor</a> для мониторинга нагруженности
контейнеров.</p>
<p>Поскольку у нас уже есть такой чудесный инструмент как cAdvisor, и мы умеем
получать от него показатели утилизации CPU для выбранных контейнеров, то почему
бы нам не выставлять вес серверов бекенда в зависимости от этого показателя?</p>
<p>Именно так я и думал, когда сел писать простой скрипт на Python,
который бы запускался раз в минуту по cron, и с помощью
<a href="http://cbonte.github.io/haproxy-dconv/configuration-1.4.html#9.2">socket-команд</a>
менял бы вес сервера в балансировке в зависимости от значения нагрузки
на этот сервер, полученного от cAdvisor API.</p>
<p>Результатом моей работы стал скрипт <strong><a href="https://github.com/abulimov/haproxy-cadvisor">haproxy_cadvisor.py</a></strong>,
который делает ровно то, что я описал.</p>
<p>При этом логика выставления весов очень проста:</p>
<ol>
<li>получаем процент использования CPU для всех бекенд-контейнеров и
считаем среднюю нагрузку;</li>
<li>для каждого сервера получаем через socket HAProxy текущий вес и
сопоставляем с текущей нагрузкой;</li>
<li>для каждого сервера определяем как надо изменить вес в балансировке,
чтобы получить нагрузку, равную посчитанной средней;</li>
<li>для каждого сервера выставляем новый вес, изменив его значение на половину
разницы между текущим весом и требуемым весом, чтобы сгладить скачки нагрузки.</li>
</ol>
<p>В качестве файла с настройками используется простой json-файл, в котором
указывается путь к сокету HAProxy, список URL для опрашиваемых сервисов cAdvisor,
название бекенда в HAProxy, для которого будет осуществлятся динамическое
выставление весов серверов, и регулярное выражение для выбора серверов бекенда из
списка алиасов контейнеров, полученного от cAdvisor.</p>
<p>Достоинства получившегося решения:</p>
<ul>
<li>Динамическое выставление весов серверов бекенда в зависимости
нагрузки на них;</li>
<li>Простота кода и использования:
<ul>
<li>конфиг в json</li>
<li>работа в Python 2.7+ и Python 3.2+</li>
<li>кроме стандартной библиотеки Python используется только Requests.</li>
</ul>
</li>
<li>Устойчивость к отказу cAdvisor - мы меняем веса только для тех серверов, для
которых получены свежие данные по загруженности.</li>
</ul>
<p>Поскольку скрипт создавался максимально простым, он (на момент написания этой
заметки) обладает и рядом недостатков:</p>
<ul>
<li>Сервисы cAdvisor опрашиваются последовательно;</li>
<li>Один скрипт может контролировать балансировку только одного бекенда в HAProxy;</li>
<li>Скрипт не поддерживает работу в режиме сервиса и требует запуска по cron.</li>
</ul>
<p>Также хочу отметить особенность работы этого решения при наличии нескольких
одновременно работающих серверов-балансировщиков. Заключается она в том,
что поскольку скрипты на этих серверах работают независимо, и никакой
информацией не обмениваются, то и веса выставляют независимо. Это может
привести к ситуации, когда на одном HAProxy для сервера будет выставлен
минимально возможный вес 1, а на втором вес существенно больший среднего.
На работу балансировки это конечно не влияет, поскольку итоговая нагрузка
получается требуемой, но этот момент следует иметь в виду.
Ну и в случае выхода одного из балансировщиков из строя, второму потребуется
пара минут на выравнивание нагрузки.</p>
<p>Описанный скрипт работает у меня в бою уже достаточно продолжительное время,
и отлично себя зарекомендовал. И что интересно - уже после создания этого
решения, читая про <a href="http://prometheus.io/">Prometheus</a> я обнаружил
<a href="http://www.boxever.com/balancing-based-on-utilisation-with-haproxy">статью от boxever.com</a>,
в которой описан аналогичный подход, однако сам итоговый продукт они
почему-то не выложили.</p>
<p>Я же очень люблю opensource, и поэтому описанный в этой заметке скрипт доступен
всем желающим под лицензией MIT в <a href="https://github.com/abulimov/haproxy-cadvisor">репозитории на github</a>.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.me/tags/haproxy/">HAProxy</a>

  <a href="//bulimov.me/tags/cadvisor/">cAdvisor</a>

  <a href="//bulimov.me/tags/python/">Python</a>

  <a href="//bulimov.me/tags/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/">Программирование</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.me/categories/it/">IT</a>

  <a href="//bulimov.me/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.me">Alexander Bulimov</a> 2013 &ndash; 2022 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

