<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quis custodiet ipsos custodes? | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.me">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Quis custodiet ipsos custodes?</span></h1>

<h2 class="date">2015/11/06</h2>

</div>

<main>
<h4 id="кто-же-устережёт-самих-сторожейhttpsruwikipediaorgwikiquis_custodiet_ipsos_custodes3f-или-как-и-зачем-я-мониторю-мониторинг"><a href="https://ru.wikipedia.org/wiki/Quis_custodiet_ipsos_custodes%3F">Кто же устережёт самих сторожей?</a>, или как (и зачем) я мониторю мониторинг.</h4>
<p>Как вы понимаете, современный сервис мониторинга это очень сложная штука.
Некоторые, как <a href="https://sensuapp.org">Sensu</a>, выносят всю сложность во внешние
сервисы, и потому требуют установки и администрирования
<a href="https://sensuapp.org/docs/latest/overview#sensu-components">нескольких компонентов</a>,
таких как очередь и база данных.</p>
<p>Остальные реализуют некоторый функционал этих компонентов сами,
упрощая администрирование мониторинга, но усложняя его внутреннее устройство.
К примеру, для работы <a href="http://www.zabbix.com/ru/">Zabbix</a> нужна только база,
а очереди и транспорт он реализует сам. Для работы <a href="https://www.icinga.org/icinga/icinga-2/">Icinga2</a>
даже база не нужна, пока не возникнет надобность в тесной интеграции с веб-интерфейсом.</p>
<p>В любом случае, чтобы быть уверенным в том, что сам мониторинг работает,
приходится настраивать мониторинг мониторинга.</p>
<h4 id="мой-опыт">Мой опыт</h4>
<p><img src="/images/monit.png" alt="Yo Dawg"></p>
<p>В моей практике так сложилось, что на проектах всегда была пара служебных
серверов, выполняющих роль DNS-сервера, локального репозитория и т.п.
На одном из них как раз и размещался мониторинг.</p>
<p>В давние времена, когда я использовал Zabbix, на втором сервере также
был установлен Zabbix-сервер, который мониторил соседа, и в случае его смерти
принял бы последний дамп его базы (увы, для Zabbix очень сложно перенести все
настройки без dump-restore базы). Таким образом, оба Zabbix-сервера мониторили
друг-друга, и я был относительно спокоен.</p>
<p>Теперь, когда я использую Icinga2, которую полностью разворачиваю вместе с
конфигами из Ansible за пару минут, нет смысла держать второй такой сервер.</p>
<p>Поэтому для мониторинга Icinga2 я выбрал гораздо более простой (и потому более
надежный) сервис <a href="http://mmonit.com">Monit</a>. У него очень мощный, и при этом
хорошо читаемый формат конфигов, и у меня с ним был отличный опыт на личном VPS.</p>
<p>Теперь мое спокойствие обеспечивает следующая конфигурация:</p>
<ul>
<li>на сервере мониторинга Monit следит за тем, что Icinga2 жива</li>
</ul>
<pre tabindex="0"><code>check process icinga2
  with pidfile /var/run/icinga2/icinga2.pid
  mode passive
</code></pre><ul>
<li>на соседе Monit следит, что сервер мониторинга жив</li>
</ul>
<pre tabindex="0"><code>check host monitoring with address monitoring.example.com
  if failed icmp type echo count 5 with timeout 15 seconds then alert
</code></pre><p>Ну и конечно Icinga2 следит за тем, что оба процесса Monit на серверах живы.</p>
<p>Проще не придумаешь, и потому я даже более спокоен, чем в схеме с двумя
Zabbix-серверами.</p>
<p>Если вам эта схема кажется параноидальной - вы абсолютно правы, определенная
степень паранойи это необходимая часть профессии сисадмина. Очень неприятно
узнать о том, что мониторинг упал с Segfault пару дней назад, и из-за этого
ты пропустил несколько важных алертов с боевых серверов.</p>
<p><strong>UPDATE</strong></p>
<p>Забыл рассказать про схему, которую использовал с Sensu. Там было лучше всего -
я использовал кластер из RabbitMQ с durable очередями и Redis с auto failover.
А сам Sensu отлично умеет масштабирование и HA с несколькими серверами из коробки.</p>
<p>Ну и насколько это было нужно, из личного опыта, в реторспективе:</p>
<ul>
<li>Zabbix падал, и второй хост это засекал;</li>
<li>Sensu падал, и второй хост это засекал;</li>
<li>Icinga2 пока не падал.</li>
</ul>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.me/tags/icinga2/">Icinga2</a>

  <a href="//bulimov.me/tags/monit/">Monit</a>

  <a href="//bulimov.me/tags/monitoring/">Monitoring</a>

  <a href="//bulimov.me/tags/%D0%BE%D0%BF%D1%8B%D1%82/">Опыт</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.me/categories/it/">IT</a>

  <a href="//bulimov.me/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.me">Alexander Bulimov</a> 2013 &ndash; 2023 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

