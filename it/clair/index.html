<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Проверка образов Docker на уязвимости с Clair | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.ru">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Проверка образов Docker на уязвимости с Clair</span></h1>

<h2 class="date">2016/03/24</h2>

</div>

<main>
<p>Ни для кого не секрет, что контейнеры (и в частности Docker) не только решают
много проблем (configuration drift, scalability, dependency hell), но и привносят новые
(в частности, обновление базовых образов).</p>
<p>Я уже давно мониторил IT-мир на предмет появления хорошего инструмента для
проверки <a href="http://docker.com">Docker</a>-образов на наличие известных CVE.
До недавнего времени подходящего инструмента не было. Была парочка дистро-специфичных
инструментов (например <a href="https://github.com/OpenSCAP/container-compliance">oscap-docker</a>,
с которым я помучался и забил), но ничего подходящего.</p>
<p>Но недавно (19.03.2016) CoreOS выпустил первый
стабильный релиз инструмента под названием <a href="https://github.com/coreos/clair">Clair</a>,
который как раз и предназначен для проверки образов Docker и <a href="https://github.com/appc/spec">appc</a>,
и поддерживает Debian, Ubuntu и RedHat.</p>
<p>К продуктами от создателей CoreOS я отношусь с <a href="/it/coreos-opinion">нескрываемым</a>
<a href="/it/goodby-coreos">подозрением</a>, однако за неимением альтернатив решил попробовать.</p>
<p>К моему удивлению, оно работает. Конечно, все еще сыро - например, можно
проверять образ на наличие уязвимостей, когда Clair еще даже не скачало базу
этих самых уязвимостей, и получить отличный результат - все чисто.</p>
<p>А утилита для проверки образов из консоли
<a href="https://github.com/coreos/clair/issues/117">не убирается за собой в /tmp</a>,
потому что разработчики не знают, что
<a href="https://gobyexample.com/exit">в Go вызов <code>os.Exit()</code> пропускает все defer-функции</a>.</p>
<p>Но даже несмотря на эти мелкие проблемы - инструмент вышел не просто рабочим,
а вполне пригодным к регулярному использованию.</p>
<p>Так что после непродолжительных игрищ с Clair я прикрутил его к нашему CI-серверу
(<a href="https://jenkins.io">Jenkins</a>), и настроил регулярную проверку
наших базовых образов.</p>
<p>Выглядит это как-то так:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">image<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$name<span style="color:#e6db74">:</span>$version<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;pulling image </span>$image<span style="color:#e6db74">&#34;</span>
pull<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>docker pull <span style="color:#e6db74">&#34;</span>$image<span style="color:#e6db74">&#34;</span> &gt;/dev/null<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#ae81ff">0</span> -ne $? <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;pull failed!&#34;</span>
  echo <span style="color:#e6db74">&#34;</span>$pull<span style="color:#e6db74">&#34;</span> | tail -n <span style="color:#ae81ff">20</span>
  exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>
echo <span style="color:#e6db74">&#34;analyzing </span>$image<span style="color:#e6db74">&#34;</span>
out<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>analyze-local-images <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -minimum-severity High <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -endpoint http://clair.ip.address.here:6060 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -my-address own.ip.address.here <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;</span>$image<span style="color:#e6db74">&#34;</span> 2&gt;&amp;1<span style="color:#66d9ef">)</span>
status<span style="color:#f92672">=</span>$?

<span style="color:#75715e"># cleanup is done separately, with docker-gc running on cron</span>
<span style="color:#75715e"># docker rmi &#34;$image&#34;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#ae81ff">0</span> -ne $status <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;analyze failed!&#34;</span>
  echo <span style="color:#e6db74">&#34;</span>$report<span style="color:#e6db74">&#34;</span>
  exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>

report<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$out<span style="color:#e6db74">&#34;</span> | grep -A <span style="color:#ae81ff">10000</span> <span style="color:#e6db74">&#39;Clair report for image&#39;</span><span style="color:#66d9ef">)</span>
echo <span style="color:#e6db74">&#34;</span>$report<span style="color:#e6db74">&#34;</span> | grep CVE &gt;/dev/null
found_cve<span style="color:#f92672">=</span>$?
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#ae81ff">0</span> -eq $found_cve <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;</span>$report<span style="color:#e6db74">&#34;</span>
  exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>

echo <span style="color:#e6db74">&#34;</span>$report<span style="color:#e6db74">&#34;</span>
</code></pre></div><p>Использую пока такой-вот скрипт-обертку вокруг
<a href="https://github.com/coreos/clair/tree/master/contrib/analyze-local-images">консольной утилиты</a>,
хотя наличие у Clair <a href="https://github.com/coreos/clair/blob/master/api/v1/README.md">вменяемого API</a>
очень сильно радует.</p>
<p>Из минусов (кроме относительной сырости) - использование API требует хорошего
копания в кишках образа контейнера, что для Docker чревато поломкой в каком-либо новом релизе.</p>
<p>Но сам факт, что наконец-то появился такой инструмент очень радует, и хочется
надеяться на скорую его интеграцию в registry (уже есть в <a href="https://github.com/containerops/dockyard">dockyard</a>)
и CI-pipeline.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.ru/tags/clair/">Clair</a>

  <a href="//bulimov.ru/tags/docker/">Docker</a>

  <a href="//bulimov.ru/tags/coreos/">CoreOS</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.ru/categories/it/">IT</a>

  <a href="//bulimov.ru/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.ru">Alexander Bulimov</a> 2013 &ndash; 2021 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

