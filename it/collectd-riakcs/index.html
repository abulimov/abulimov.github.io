<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Плагин к collectd для сбора метрик Riak CS | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.me">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Плагин к collectd для сбора метрик Riak CS</span></h1>

<h2 class="date">2015/09/17</h2>

</div>

<main>
<p>На днях наконец-то дошли руки до модернизации той части мониторинга, которая
отвечает за сбор метрик, и набивший оскомину <a href="http://munin-monitoring.org">Munin</a> был
окончательно заменен на <a href="https://graphite.readthedocs.org/en/latest/">Graphite</a> + <a href="http://collectd.org">collectd</a>.
Теперь воцарилась идиллия - Icinga2 складывает метрики из perfdata в Graphite,
и collectd отправляет все метрики туда же.</p>
<p>Хочется отдельно отметить, что несмотря на то, что изначально collectd мне
не очень понравился (кому может сейчас понравиться Apache-подобный конфиг?), при
дальнейшем изучении я был приятно поражен богатством возможностей этого
продукта и крайне бережным его отношением к ресурсам наблюдаемой системы.</p>
<p>Так вот, в процессе переезда с Munin я столкнулся с задачей сбора в collectd
метрик с замечательной реализации приватного
<a href="https://ru.wikipedia.org/wiki/Amazon_S3">S3</a>-совместимого хранилища -
<a href="http://docs.basho.com/riakcs/latest">Riak CS</a>.</p>
<p>К слову сказать, с Riak я работаю уже не первый год, и всегда был очень доволен
этим решением, и Riak CS также оправдал все ожидания - он удобный в настройке
и эксплуатации (начиная с версии 2.0 появился даже удобный конфиг - раньше
конфиг был на Erlang), быстрый, надежный, отказоустойчивый, и очень просто масштабируется.
Так что если выбираете хранилище для файлов, доступ к которому нужен по http и
библиотеки для работы с которым есть для любого языка - Riak CS это отличный выбор,
тем более можно при желании смигрировать на любое S3-совместимое хранилище - на
<a href="http://ceph.com">Ceph</a>, например.</p>
<p>Сам Riak CS построен как надстройка над Riak, для которого в официальной
документации <a href="http://docs.basho.com/riak/1.4.8/ops/running/monitoring/collectd/">есть пример конфига для collectd</a>.</p>
<p>К сожалению, для Riak CS такой фокус с плагином <em>curl_json</em> не пройдет - для
доступа к статистике http-запрос должен быть подписан по всем правилам
авторизации S3, поэтому пришлось писать свой плагин, благо collectd
<a href="https://collectd.org/documentation/manpages/collectd-python.5.shtml#writing_your_own_plugins">предоставляет</a>
очень простой интерфейс для написания плагинов на Python, а в Python есть
шикарная библиотека <a href="https://www.python-requests.org/">requests</a>, к которой есть удобный
модуль для работы с S3 - <a href="https://github.com/tax/python-requests-aws">requests-aws</a>.</p>
<p>Для написания простейшего плагина к collectd надо реализовать и
зарегистрировать всего одну функцию - read. То есть вот так выгладит минимальный
плагин к Colletcd:</p>
<p><em>Пример из официальной документации:</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> collectd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(data<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;collectt and dispatch some data&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    vl <span style="color:#f92672">=</span> collectd<span style="color:#f92672">.</span>Values(type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gauge&#39;</span>)
</span></span><span style="display:flex;"><span>    vl<span style="color:#f92672">.</span>plugin<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python.spam&#39;</span>
</span></span><span style="display:flex;"><span>    vl<span style="color:#f92672">.</span>dispatch(values<span style="color:#f92672">=</span>[random<span style="color:#f92672">.</span>random() <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>collectd<span style="color:#f92672">.</span>register_read(read)
</span></span></code></pre></div><p>Мне, конечно, пришлось написать немного больше кода, но поскольку сам Riak CS
очень помогает c метриками - он отдает всю нужную информацию, включая
95й и 99й перцентили задержек различных операций, в
<a href="http://docs.basho.com/riakcs/latest/cookbooks/Monitoring-and-Metrics/">в обычном JSON</a>,
это действительно <em>немного</em> больше кода.</p>
<p>Плагин получился крошечным - меньше 100 строк кода - и
очень простым.</p>
<p>Код плагина к collectd для снятия метрик с Riak CS трационно опубликован под
свободной лицензией <a href="https://opensource.org/licenses/MIT">MIT</a>
на Github - <a href="https://github.com/abulimov/collectd-riakcs">github.com/abulimov/collectd-riakcs</a>,
а сам плагин подготовлен к удобной <a href="https://github.com/abulimov/collectd-riakcs#setup">установке через pip</a>.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.me/tags/python/">Python</a>

  <a href="//bulimov.me/tags/riak-cs/">Riak CS</a>

  <a href="//bulimov.me/tags/collectd/">collectd</a>

  <a href="//bulimov.me/tags/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/">Программирование</a>

  <a href="//bulimov.me/tags/monitoring/">Monitoring</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.me/categories/it/">IT</a>

  <a href="//bulimov.me/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.me">Alexander Bulimov</a> 2013 &ndash; 2023 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

