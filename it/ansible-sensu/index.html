<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Удобная настройка Sensu с Ansible | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.ru">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Удобная настройка Sensu с Ansible</span></h1>

<h2 class="date">2014/11/13</h2>

</div>

<main>
<p>Так как я использую <a href="http://sensuapp.org/">Sensu</a> для мониторинга,
и <a href="http://www.ansible.com/">Ansible</a> для управления конфигурациями,
то конечно же я настраиваю Sensu с помощью Ansible.</p>
<p>В этой связке меня смущало только одно - Sensu использует
<a href="https://ru.wikipedia.org/wiki/JSON">JSON</a> для конфигов,
в то время как Ansible использует <a href="https://ru.wikipedia.org/wiki/YAML">YAML</a>.
Поскольку JSON является подмножеством YAML, и описывать
конфигурации в YAML гораздо проще (никаких проблем с запятыми, скобочками),
хотелось писать в YAML и транслировать в JSON.</p>
<p>Начал я, конечно, с использования шаблонов Ansible:</p>
<pre><code>:::json
{
    &quot;client&quot;: {
        &quot;address&quot;: &quot;{{ ansible_default_ipv4.address }}&quot;,
        &quot;name&quot;: &quot;{{ ansible_hostname }}&quot;,
        &quot;subscriptions&quot;: [ &quot;{{ sensu_client_subscriptions|join('&quot;, &quot;') }}&quot; ]
    }
}
</code></pre>
<p>Вроде неплохо, но не слишком удобно, и если одним клиентам захочется добавить
что-то, например переменную <code>some_var</code>, надо для них делать новый шаблон, или
городить строки такого вида:</p>
<pre><code>{% if some_var is defined %} &quot;some_var&quot;: {{ some_var }}, {% endif %}
</code></pre>
<p>В общем, я, не особо включая мозг, решил писать модуль для Ansible.</p>
<p>В процессе написания выплыли все те же проблемы: сложно работать с произвольного
вида структурами, которые позволяют с такой гибкостью использовать Sensu.</p>
<p>То есть для примера с добавлением переменной клиенту, нашему модулю пришлось бы
поддерживать не только обязательные параметры клиента, такие как имя, адрес
и список подписок, но еще и аргумент, в который мы пихали бы остальные данные.
Да еще и структура описания у Sensu в тот момент менялась от версии к версии.</p>
<p>И тут я наткнулся на <a href="https://github.com/ansible/ansible/pull/2234">pull-request</a>,
из которого узнал, что теперь в Ansible можно использовать =
фильтры <em>to_json</em> и <em>to_nice_json</em>.</p>
<p>А это дает нам возможность делать такие вещи:</p>
<pre><code>:::yaml
# task from sensu_client role
- name: configure sensu client
  copy: content='{{ sensu_client | to_nice_json }}'
        owner=sensu
        dest=/etc/sensu/conf.d/client.json
  notify:
    - restart sensu-client
</code></pre>
<p>А описание переменной <em>sensu_client</em> где-нибудь в <em>group_vars</em> выглядит так:</p>
<pre><code>:::yaml
sensu_client:
  client:
    name: &quot;{{ ansible_hostname }}&quot;
    subscriptions:
      - www
      - default
    address: &quot;{{ ansible_default_ipv4.address }}&quot;
    some_var: &quot;{{ sensu_some_var }}&quot;
</code></pre>
<p>Эта схема показалась мне достаточно удобной, и на этом я остановился,
так что теперь весь конфиг Sensu, включая проверки, хендлеры и т.д., хранится
у меня в формате YAML в Ansible.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.me/tags/ansible/">Ansible</a>

  <a href="//bulimov.me/tags/sensu/">Sensu</a>

  <a href="//bulimov.me/tags/monitoring/">Monitoring</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.me/categories/it/">IT</a>

  <a href="//bulimov.me/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.me">Alexander Bulimov</a> 2013 &ndash; 2022 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

