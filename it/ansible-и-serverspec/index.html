<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ansible и serverspec | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.ru">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Ansible и serverspec</span></h1>

<h2 class="date">2014/05/22</h2>

</div>

<main>
<p>Когда я готовил playbook для <a href="/it/%D0%9B%D0%B8%D1%87%D0%BD%D1%8B%D0%B9-vps">своего VPS</a>, я взял за основу
<a href="https://github.com/al3x/sovereign">Sovereign</a>. В этом репозитории меня
заинтересовал файл <strong>tests.py</strong>, содержащий тесты для результирующего сервера.
У меня сразу же возник вопрос - почему тесты самописные, на голом Python, а
не на каком-нибудь готовом решении. Я решил изучить, что же есть сейчас для
TDD-администрирования. Оказалось, что толком ничего и нет, а то, что
есть - для Ansible не особо нужно.</p>
<p>Для начала, что есть. Тут все скучно, есть <a href="http://serverspec.org/">serverspec</a>,
и <a href="https://pypi.python.org/pypi/envassert"><code>envassert</code></a>. Оба эти инструмента
предоставляют возможность декларативно описать требуемое состояние удаленного
сервера, и проверить его соответствие реальности по ssh.</p>
<p>Вот пример для serverspec с официального сайта:</p>
<pre><code>:::ruby
require 'spec_helper'

describe package('httpd') do
  it { should be_installed }
end

describe service('httpd') do
  it { should be_enabled   }
  it { should be_running   }
end

describe port(80) do
  it { should be_listening }
end

describe file('/etc/httpd/conf/httpd.conf') do
  it { should be_file }
  its(:content) { should match /ServerName www.example.jp/ }
end
</code></pre>
<p>Все чудесно, и для того же Chef это отличный инструмент, поскольку
сам Chef провоцирует писать императивный код на Ruby, который хорошо было бы
проверять простым декларативным описанием.</p>
<p>Но в случае Ansible, наш playbook <strong>уже</strong> содержит декларативное описание
требуемого состояния.</p>
<p>Вот фрагмент роли Nginx для Ansible.</p>
<pre><code>:::yaml
- name: Ensure nginx package is installed
  apt: pkg=nginx state=latest

- name: Ensure nginx service is enabled and started
  service: name=nginx state=started enabled=yes

- name: Place nginx.conf
  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf mode=644
  notify:
    - reload nginx
</code></pre>
<p>Как можно заметить, описание Ansible не содержит только проверок портов, зато
позволяет привести систему к описываемому виду, а не только проверить на соответствие.</p>
<p>Таким образом, имеет смысл использовать serverspec с Ansible только для проверки
таких параметров, как слушающие порты, правила iptables, и настройки сетевых
интерфейсов - все остальное Ansible и проверяет, и приводит к нужному состоянию.
Но в боевой системе, или в staging-окружении, эти параметры и так будут проверяться
системой мониторинга, причем на постоянной основе.</p>
<p>Видимо, именно поэтому репозиторий sovereign содержит самописные тесты, которые
проверяют не столько состояние системы, сколько корректность работы
сконфигурированных сервисов. К сожалению, инструмент, который бы облегчил задачу
написания таких тестов, еще не написан, хотя было бы здорово расширить serverspec
для проверки корректности работы http-сервисов, либо imap-сервера, дополнить его
более высокоуровневыми проверками.</p>
<p>Я для себя пока решил, что написание serverspec-тестов для Ansible избыточно
при наличии staging-окружения с работающим мониторингом и фунциональными тестами,
однако инструмент это явно полезный и перспективный.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.me/tags/ansible/">Ansible</a>

  <a href="//bulimov.me/tags/serverspec/">serverspec</a>

  <a href="//bulimov.me/tags/%D0%BC%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5/">Мнение</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.me/categories/it/">IT</a>

  <a href="//bulimov.me/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.me">Alexander Bulimov</a> 2013 &ndash; 2021 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

