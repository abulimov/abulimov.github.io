<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Расширяем возможности Nginx с помощью Lua | Alexander Bulimov: Production Engineer and Scale Modeller</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="https://models.bulimov.me">Scale Models</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/reviews/">Reviews</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Расширяем возможности Nginx с помощью Lua</span></h1>

<h2 class="date">2013/11/08</h2>

</div>

<main>
<p>Встала некоторое время назад передо мной задача -
фильтровать по полю Serial клиентские сертификаты,
которые используются для авторизации на одном из сервисов.
То есть не просто проверять сертификат, но еще и проверять
наличие серийника в списке разрешенных, на случай утечки клиентского
сертификата. Сертификаты выдаем не мы, так что отзывать не можем,
и списка отозванных тоже нет.</p>
<p>Решать я эту задачу стал с помощью Nginx, и почти сразу был
слеплен вариант тупой вариант &ldquo;в лоб&rdquo;:</p>
<pre><code>:::nginx
set $valid_serial 'false';
if ($ssl_client_serial ~ '01') { set $valid_serial 'true'; }
if ($ssl_client_serial ~ '02') { set $valid_serial 'true'; }
...
if ($ssl_client_serial ~ 'NN') { set $valid_serial 'true'; }
if ($valid_serial ~ false) { return 403; break; }
</code></pre>
<p>Поскольку конфиг генерируется из Ansible, то шаблон
вышел простой, и для каждого из серийников генерируется
нужная строчка с if. Так оно и работала при тестовом списке в
3-5 серийников, но приближалось время, когда список должен
был вырасти до 100+, а затем и до 1000+&hellip;</p>
<p>Поэтому была проведена изыскательская работа, которая привела
меня к <a href="http://wiki.nginx.org/HttpLuaModule">модулю Lua для Nginx</a>.
Выяснилось, что на нем реализуют весьма сложную логику при приличных
нагрузках, о чем есть куча статей, даже на Хабре есть вполне годная
<a href="http://habrahabr.ru/company/2gis/blog/199504/">статья</a>.</p>
<p>Так что я быстро пересобрал свой пакет с Nginx с модулем Lua,
и начал ваять, благо логика у моем случае простейшая:</p>
<ol>
<li>Загружаем при старте Nginx из файлика с серийниками их список в <code>ngx.shared.DICT</code></li>
</ol>
<pre tabindex="0"><code>lua_shared_dict serials 1m;

init_by_lua &#39;
local file = io.open(&#34;/etc/nginx/access.list&#34;, &#34;r&#34;)
local serials = ngx.shared.serials
if file then
    for line in file:lines() do
    local stripped_line = line:match( &#34;^%s*(.-)%s*$&#34; )
    local succ, err, forcible = serials:safe_set( stripped_line, true)
    if not succ then
        ngx.log(ngx.ERR,&#34;error populating serials list: &#34; .. err)
    end
    end
    file:close()
else
    ngx.log(ngx.ERR,&#34;access.list file not found&#34;)
end
&#39;;
...
</code></pre><ol start="2">
<li>При запросе к защищенному контенту проверяем, есть ли такой серийник в списке.</li>
</ol>
<pre tabindex="0"><code>location / {
access_by_lua &#39;
    local serial = ngx.var.ssl_client_serial
    local value, flags = ngx.shared.serials:get(serial)
    if not value then
    ngx.log(ngx.WARN, &#34;blocked client cert &#34; .. serial)
    ngx.exit(ngx.HTTP_FORBIDDEN)
    end
&#39;;
proxy_pass http://upstream;
}
</code></pre><p>Весь Lua-код выполняется в отдельных корутинах-песочницах, так что на работу
в Nginx в целом не влияет.
И что особенно хорошо, можно будет в дальнейшем список вынести в базу данных,
к примеру.</p>
<p>В общем, я был и без того очень впечатлен
возможностями Nginx, а с модулем Lua он еще круче.</p>

</main>


<p class="terms">
<b>Tags:</b>

  <a href="//bulimov.me/tags/nginx/">Nginx</a>

  <a href="//bulimov.me/tags/lua/">Lua</a>


</p>
<p class="terms">

<b>Categories:</b>

  <a href="//bulimov.me/categories/it/">IT</a>

  <a href="//bulimov.me/categories/russian/">Russian</a>


</p>

  <footer>
  
  
  <hr/>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="License: CC BY-SA 4.0"></a> © <a href="http://bulimov.me">Alexander Bulimov</a> 2013 &ndash; 2025 | <a href="https://github.com/abulimov">Github</a>
  
  </footer>
  </body>
</html>

